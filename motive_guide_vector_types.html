<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Motive Animation System: Using Your Own Vector Types</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,700" rel="stylesheet">
<link href="style.css" rel="stylesheet" type="text/css"/>
<script>
  /**
   * Check if the browser rendering this page is being run on an Android device.
   * It checks if the string 'android' is found in the browser's `userAgent`.
   * @return {boolean} This returns `true` if the browser's `userAgent` contains
   * the string 'android' (indicating that the browser is on an Android device).
   * Otherwise, it returns `false`.
   */
  function isAndroidDevice() {
    if (navigator && navigator.userAgent) {
      return navigator.userAgent.toLowerCase().indexOf('android') != -1;
    } else {
      return false;
    }
  }
  /**
   * Check if an HTML `class` attribute is in the browser-specific format.
   * @param {string} An HTML `class` attribute in the format 'browser-{device}'.
   * @return {boolean} Returns `true` if `browserClass` was in the valid format,
   * prefixed with 'browser-'. Otherwise, it returns false.
   */
  function isBrowserSpecificClassName(browserClass) {
    if (browserClass && browserClass.substring(0, 8) == 'browser-' &&
        browserClass.length > 8) {
      return true;
    } else {
      return false;
    }
  }
  /**
   * Get all the HTML Elements with browser-specific `class` attributes.
   * @return {array} Returns an array of all the HTML Elements with a `class`
   * attribute that is prefixed with `browser-`.
   */
  function getAllBrowserSpecificElements() {
    if (document) {
      var htmlElements = document.getElementsByTagName("*");
      var browserSpecificElements = [];
      for (var i = 0; i < htmlElements.length; i++) {
        if (isBrowserSpecificClassName(htmlElements[i].className)) {
          browserSpecificElements.push(htmlElements[i]);
        }
      }
      return browserSpecificElements;
    } else {
      return null;
    }
  }
  /**
   * Given a browser-specific HTML `class` attribute, extract the device name.
   * @param {string} browserClass The string name of an HTML `class` attribute,
   * in the format `browser-{device}`.
   * @return {string} Returns a string containing only the device portion of
   * the class name. If the input was invalid, then it returns `null`.
   */
  function extractDeviceFromBrowserClass(browserClass) {
    if (isBrowserSpecificClassName(browserClass)) {
      return browserClass.substring(8);
    }
    else {
      return null;
    }
  }
  /**
   * Hide device specific elements that do not apply to the current device.
   */
  function handleDeviceSpecificLoading() {
    var browserSpecificElements = getAllBrowserSpecificElements();
    for (var i = 0; i < browserSpecificElements.length; i++) {
      var device = extractDeviceFromBrowserClass(browserSpecificElements[i].className);
      if (device && !isAndroidDevice() && device == 'android') {
        browserSpecificElements[i].innerHTML = '';
      } else if(device && isAndroidDevice() && device == 'desktop') {
        browserSpecificElements[i].innerHTML = '';
      }
    }
  }
  $(document).ready(handleDeviceSpecificLoading);
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="commonprojectlogo">
    <img alt="Logo" src="fpl_logo_small.png"/>
  </td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Motive Animation System
   </div>
   <div style="font-size:12px;">
	 An open source project by
     <a href="https://developers.google.com/games/#Tools">FPL</a>.
  </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="usergroup0.html"><span>Building</span></a></li>
      <li><a href="usergroup1.html"><span>Programmer's&#160;Guide</span></a></li>
      <li><a href="motive_api_reference.html"><span>API&#160;Reference</span></a></li>
      <li><a href="motive_readme.html"><span>Readme</span></a></li>
      <li><a href="contributing.html"><span>Contributing</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('motive_guide_vector_types.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using Your Own Vector Types </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="motive_guide_vector_types_overview"></a>
Overview</h1>
<p>Internally, Motive uses <code>mathfu</code> types. For example, all the data in a <code>MotiveProcessor</code> is transmitted using <code>mathfu::vec3</code>, <code>mathfu::mat4</code>, etc.</p>
<p>The external API can be wrapped in a conversion layer. You can supply your own vector types, together with conversion functions to and from <code>mathfu</code> types.</p>
<h1><a class="anchor" id="motive_guide_vector_types_example"></a>
Example</h1>
<p>For example, suppose you have these vector types in your code base:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>MyMatrix4 {</div>
<div class="line">  <span class="keywordtype">float</span> m[4][4];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> kDimension&gt;</div>
<div class="line"><span class="keyword">struct </span>MyVecTemplate {</div>
<div class="line">  <span class="keywordtype">float</span> v[kDimension];</div>
<div class="line"></div>
<div class="line">  <span class="keyword">explicit</span> MyVecTemplate(<span class="keyword">const</span> <span class="keywordtype">float</span>* pointer) {</div>
<div class="line">    memcpy(v, pointer, <span class="keyword">sizeof</span>(v));</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> MyVecTemplate&lt;2&gt; MyVec2;</div>
<div class="line"><span class="keyword">typedef</span> MyVecTemplate&lt;3&gt; MyVec3;</div>
<div class="line"><span class="keyword">typedef</span> MyVecTemplate&lt;4&gt; MyVec4;</div>
</div><!-- fragment --><p> Then, in your own header file, you can define a conversion class like this:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyVectorConverter {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="comment">// Define our vector types in the public section.</span></div>
<div class="line">  <span class="keyword">typedef</span> MyVec2 Vector2;</div>
<div class="line">  <span class="keyword">typedef</span> MyVec3 Vector3;</div>
<div class="line">  <span class="keyword">typedef</span> MyVec4 Vector4;</div>
<div class="line">  <span class="keyword">typedef</span> MyMatrix4 Matrix4;</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Convert the data types to pointers. Note that we currently assume that</span></div>
<div class="line">  <span class="comment">// external matrices are in column-major format, the same as mathfu&#39;s.</span></div>
<div class="line">  <span class="comment">// A future change will store the matrices as row-major AffineTransforms</span></div>
<div class="line">  <span class="comment">// instead of 4x4 matrices.</span></div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">float</span>* ToPtr(<span class="keywordtype">float</span>&amp; f) { <span class="keywordflow">return</span> &amp;f; }</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">float</span>* ToPtr(Vector2&amp; v) { <span class="keywordflow">return</span> &amp;v.v[0]; }</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">float</span>* ToPtr(Vector3&amp; v) { <span class="keywordflow">return</span> &amp;v.v[0]; }</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">float</span>* ToPtr(Vector4&amp; v) { <span class="keywordflow">return</span> &amp;v.v[0]; }</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">float</span>* ToPtr(Matrix4&amp; m) { <span class="keywordflow">return</span> &amp;m.m[0][0]; }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// This call results in a read of &#39;f&#39; and then a write to the stack of</span></div>
<div class="line">  <span class="comment">// the return value. The optimizer will almost certainly eliminate this extra</span></div>
<div class="line">  <span class="comment">// read-write, since it does nothing.</span></div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">float</span> FromPtr(<span class="keyword">const</span> <span class="keywordtype">float</span>* f, <span class="keywordtype">float</span>) { <span class="keywordflow">return</span> *f; }</div>
<div class="line">  <span class="keyword">static</span> Vector2 FromPtr(<span class="keyword">const</span> <span class="keywordtype">float</span>* f, Vector2) { <span class="keywordflow">return</span> Vector2(f); }</div>
<div class="line">  <span class="keyword">static</span> Vector3 FromPtr(<span class="keyword">const</span> <span class="keywordtype">float</span>* f, Vector3) { <span class="keywordflow">return</span> Vector3(f); }</div>
<div class="line">  <span class="keyword">static</span> Vector4 FromPtr(<span class="keyword">const</span> <span class="keywordtype">float</span>* f, Vector4) { <span class="keywordflow">return</span> Vector4(f); }</div>
<div class="line">};</div>
</div><!-- fragment --><p> And then define a <code>MatrixMotivator</code> that uses your types in its external API:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> MatrixMotivator4fTemplate&lt;MyVectorConverter&gt; MyMatrixMotivator4f;</div>
</div><!-- fragment --> <h1><a class="anchor" id="motive_guide_vector_types_strict_aliasing"></a>
Strict Aliasing</h1>
<p>Strict aliasing is not a worry in this situation.</p>
<p>Strict aliasing bugs can occur when you cast between types. The C++ compiler is allowed to rearrange pointer operations (reads and writes) of different types. Therefore, writing a value, casting a pointer to the value to a different type, then reading from at pointer can get you into trouble: the read can be put before the write.</p>
<p>In Motive, for all conversions, the read and write are separated by a virtual function call. The compiler cannot reorder across a virtual function call boundary (because they cannot be inlined). Therefore, strict aliasing is probably not a worry.</p>
<p>So casting a <code>mathfu::mat4</code> reference to a reference of your matrix type shouldn't result in aliasing bugs. You do need to ensure that the alignment restrictions are the same, however (see below).</p>
<p>Of course, this is only true for the specific situation described here in Motive. If you reuse your conversion class elsewhere in your code, you may be setting yourself up for trouble. If you do use casts, be aware that it is a maintanence hazard.</p>
<h1><a class="anchor" id="motive_guide_vector_types_alignment"></a>
Alignment Restrictions</h1>
<p>Note that <code>mathfu</code> types will be 16-byte aligned, if you're using the SIMD option of <code>mathfu</code>. The SIMD option will make Motive run faster on most platforms, so it's a good idea to enable it when you can.</p>
<p>If your types are only 4-byte aligned, then you will need to create copies of them in your converter's <code>From</code> calls. These copies cannot be optimized away, and are therefore pure excess call overhead.</p>
<p>For maximal efficiency, you may want to consider aligning your vector types to match <code>mathfu</code> alignment. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-49880327-7', 'google.github.io');
ga('send', 'pageview');
</script>
</body>
</html>
