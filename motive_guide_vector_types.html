<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Motive Animation System: Using Your Own Vector Types</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,700" rel="stylesheet">
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="commonprojectlogo">
    <img alt="Logo" src="fpl_logo_small.png"/>
  </td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Motive Animation System
   </div>
   <div style="font-size:12px;">
	 An open source project by
     <a href="https://developers.google.com/games/#Tools">FPL</a>.
  </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="usergroup0.html"><span>Building</span></a></li>
      <li><a href="usergroup1.html"><span>Programmer's&#160;Guide</span></a></li>
      <li><a href="motive_api_reference.html"><span>API&#160;Reference</span></a></li>
      <li><a href="motive_readme.html"><span>Readme</span></a></li>
      <li><a href="contributing.html"><span>Contributing</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('motive_guide_vector_types.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using Your Own Vector Types </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="motive_guide_vector_types_overview"></a>
Overview</h1>
<p>Internally, Motive uses <code>mathfu</code> types. For example, all the data in a <code>MotiveProcessor</code> is transmitted using <code>mathfu::vec3</code>, <code>mathfu::mat4</code>, etc.</p>
<p>The external API can be wrapped in a conversion layer. You can supply your own vector types, together with conversion functions to and from <code>mathfu</code> types.</p>
<h1><a class="anchor" id="motive_guide_vector_types_example"></a>
Example</h1>
<p>For example, suppose you have these vector types in your code base:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>MyMatrix4 {</div>
<div class="line">  <span class="keywordtype">float</span> m[4][4];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> kDimension&gt;</div>
<div class="line"><span class="keyword">struct </span>MyVecTemplate {</div>
<div class="line">  <span class="keywordtype">float</span> v[kDimension];</div>
<div class="line"></div>
<div class="line">  <span class="keyword">explicit</span> MyVecTemplate(<span class="keyword">const</span> <span class="keywordtype">float</span>* pointer) {</div>
<div class="line">    memcpy(v, pointer, <span class="keyword">sizeof</span>(v));</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> MyVecTemplate&lt;2&gt; MyVec2;</div>
<div class="line"><span class="keyword">typedef</span> MyVecTemplate&lt;3&gt; MyVec3;</div>
<div class="line"><span class="keyword">typedef</span> MyVecTemplate&lt;4&gt; MyVec4;</div>
</div><!-- fragment --><p> Then, in your own header file, you can define a conversion class like this:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyVectorConverter {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="comment">// MatrixMotivator4fTemplate needs these External.</span></div>
<div class="line">  <span class="keyword">typedef</span> MyMatrix4 ExternalMatrix4;</div>
<div class="line">  <span class="keyword">typedef</span> MyVec2 ExternalVector2;</div>
<div class="line">  <span class="keyword">typedef</span> MyVec3 ExternalVector3;</div>
<div class="line">  <span class="keyword">typedef</span> MyVec4 ExternalVector4;</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Casting from mathfu::mat4 is ok. The alignment restrictions on mathfu::mat4</span></div>
<div class="line">  <span class="comment">// (16-bytes) are stricter than for MyMatrix4 (4-bytes). Also, strict aliasing</span></div>
<div class="line">  <span class="comment">// is not a problem here since &#39;m&#39; was written on the other side of a virtual</span></div>
<div class="line">  <span class="comment">// function call (see &quot;Strict Aliasing&quot; discussion in documentation).</span></div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> MyMatrix4&amp; To(<span class="keyword">const</span> mathfu::mat4&amp; m) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span>MyMatrix4&amp;<span class="keyword">&gt;</span>(m);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// This call results in a read of &#39;v&#39; and then a write to the stack of</span></div>
<div class="line">  <span class="comment">// MyVec3. The optimizer will almost certainly eliminate this extra</span></div>
<div class="line">  <span class="comment">// read-write, since it does nothing.</span></div>
<div class="line">  <span class="keyword">static</span> MyVec2 To(<span class="keyword">const</span> mathfu::vec2&amp; v) { <span class="keywordflow">return</span> MyVec2(&amp;v[0]); }</div>
<div class="line">  <span class="keyword">static</span> MyVec3 To(<span class="keyword">const</span> mathfu::vec3&amp; v) { <span class="keywordflow">return</span> MyVec3(&amp;v[0]); }</div>
<div class="line">  <span class="keyword">static</span> MyVec4 To(<span class="keyword">const</span> mathfu::vec4&amp; v) { <span class="keywordflow">return</span> MyVec4(&amp;v[0]); }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Here we have to call the constructor for matfu::vec3, because the alignment</span></div>
<div class="line">  <span class="comment">// restrictions are more strict for mathfu types (16-bytes) than for MyVec3</span></div>
<div class="line">  <span class="comment">// (4-bytes). The optimizer *may not* be able to eliminate this read-write</span></div>
<div class="line">  <span class="comment">// since &#39;v&#39; might arrive misaligned. This function may result in overhead,</span></div>
<div class="line">  <span class="comment">// therefore.</span></div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> mathfu::vec2 From(<span class="keyword">const</span> MyVec2&amp; v) {</div>
<div class="line">    <span class="keywordflow">return</span> mathfu::vec2(&amp;v.v[0]);</div>
<div class="line">  }</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> mathfu::vec3 From(<span class="keyword">const</span> MyVec3&amp; v) {</div>
<div class="line">    <span class="keywordflow">return</span> mathfu::vec3(&amp;v.v[0]);</div>
<div class="line">  }</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> mathfu::vec4 From(<span class="keyword">const</span> MyVec4&amp; v) {</div>
<div class="line">    <span class="keywordflow">return</span> mathfu::vec4(&amp;v.v[0]);</div>
<div class="line">  }</div>
<div class="line">};</div>
</div><!-- fragment --><p> And then define a <code>MatrixMotivator</code> that uses your types in its external API:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> MatrixMotivator4fTemplate&lt;MyVectorConverter&gt; MyMatrixMotivator4f;</div>
</div><!-- fragment --> <h1><a class="anchor" id="motive_guide_vector_types_strict_aliasing"></a>
Strict Aliasing</h1>
<p>Strict aliasing is not a worry in this situation.</p>
<p>Strict aliasing bugs can occur when you cast between types. The C++ compiler is allowed to rearrange pointer operations (reads and writes) of different types. Therefore, writing a value, casting a pointer to the value to a different type, then reading from at pointer can get you into trouble: the read can be put before the write.</p>
<p>In Motive, for all conversions, the read and write are separated by a virtual function call. The compiler cannot reorder across a virtual function call boundary (because they cannot be inlined). Therefore, strict aliasing is probably not a worry.</p>
<p>So casting a <code>mathfu::mat4</code> reference to a reference of your matrix type shouldn't result in aliasing bugs. You do need to ensure that the alignment restrictions are the same, however (see below).</p>
<p>Of course, this is only true for the specific situation described here in Motive. If you reuse your conversion class elsewhere in your code, you may be setting yourself up for trouble. If you do use casts, be aware that it is a maintanence hazard.</p>
<h1><a class="anchor" id="motive_guide_vector_types_alignment"></a>
Alignment Restrictions</h1>
<p>Note that <code>mathfu</code> types will be 16-byte aligned, if you're using the SIMD option of <code>mathfu</code>. The SIMD option will make Motive run faster on most platforms, so it's a good idea to enable it when you can.</p>
<p>If your types are only 4-byte aligned, then you will need to create copies of them in your converter's <code>From</code> calls. These copies cannot be optimized away, and are therefore pure excess call overhead.</p>
<p>For maximal efficiency, you may want to consider aligning your vector types to match <code>mathfu</code> alignment. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-49880327-7', 'google.github.io');
ga('send', 'pageview');
</script>
</body>
</html>
